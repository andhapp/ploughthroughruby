
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js" lang="en"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>Timing attack vulnerability in Rails - Plough => Ruby</title>
  <meta name="author" content="andHapp">

  
  <meta name="description" content="DisclaimerI am not a security expert and this post is my attempt to learn a bit more about web security.Why now?Well, I am signed up to Ruby on Rai...">
  

  <!-- http://t.co/dKP3o1e -->
  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">

  
  <link rel="canonical" href="http://ploughthroughruby.co.uk//2016/02/21/timing-attack-ruby-vulnerability.html/">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script src="/javascripts/modernizr-2.0.js"></script>
  <script src="/javascripts/ender.js"></script>
  <script src="/javascripts/octopress.js" type="text/javascript"></script>
  <link href="/atom.xml" rel="alternate" title="Plough => Ruby" type="application/atom+xml">
  <!--Fonts from Google"s Web font directory at http://google.com/webfonts -->
<link href="http://fonts.googleapis.com/css?family=PT+Serif:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="http://fonts.googleapis.com/css?family=PT+Sans:regular,italic,bold,bolditalic" rel="stylesheet" type="text/css">
<link href="//cdn-images.mailchimp.com/embedcode/slim-081711.css" rel="stylesheet" type="text/css">

</head>

<body   >
  <header role="banner"><hgroup>
  <h1><a href="/">Plough => Ruby</a></h1>
  
    <h2>Journey through ruby</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="/atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:ploughthroughruby.co.uk/" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
<ul class="main-navigation">
  <li><a href="/">Home</a></li>
  <li><a href="http://www.andhapp.com/blog">General Blog</a></li>
  <li><a href="/blog/archives">Archives</a></li>
</ul>

</nav>
  <div id="main">
    <div id="content">
      <div>
<article class="hentry" role="article">
  
  <header>
    
      <h1 class="entry-title">Timing Attack Vulnerability in Rails</h1>
    
    
      <p class="meta">
        





  



<time datetime="2016-02-21T00:00:00+00:00" pubdate  data-updated="true" >Feb 21<span>st</span>, 2016</time>
        
      </p>
    
  </header>


<div class="entry-content"><h3>Disclaimer</h3>

<p>I am not a security expert and this post is my attempt to learn a bit more about web security.</p>

<h3>Why now?</h3>

<p>Well, I am signed up to Ruby on Rails security mailing list to make sure vulnerabilities don&#8217;t go unnoticed and all my projects are running patched versions. Usually I just read the emails and ensure to upgrade or patch the affected versions and this system has worked very smoothly, however, I have never been happy with this approach and when <a href="https://groups.google.com/forum/#!topic/rubyonrails-security/ANv0HDHEC3k">a timing attack vulnerability</a>was announced on 25th January 2016 (CVE-2015-7576), I decided to research and learn more about it.</p>

<h3>What is a timing attack?</h3>

<p>A timing attack allows an adversary to learn more about the system under attack by statistically analysing information based on different response times. Here are a few examples:</p>

<ol>
<li><p>The size of response for a signed in user and a signed out user will be significantlly different, thus allowing the adversary to determine user&#8217;s current state.</p></li>
<li><p>A string comparison with no matching characters will be slightly faster than one with 2 matching characters.</p></li>
</ol>


<p>There are many more examples along the same lines. One thing worth mentioning is that it takes a lot more analysis and patience for a successful timing attack, but it&#8217;s not impossible.</p>

<h3>How can we fix the string comparision to run in constant time?</h3>

<p>Although, there are several ways to use the timing attack but in the interest of this article the scope is limited to secure string comparison in Ruby. There are two ways to do it:</p>

<h4>Activesupport</h4>

<p>Activesupport provides a <code>secure_compare</code> method that can be used like this:</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>ActiveSupport::SecurityUtils.secure_compare(a, b)</span></code></pre></td></tr></table></div></figure>


<h4>Don&#8217;t use Activesupport</h4>

<p>I took this implementation from <a href="https://goo.gl/nMFEqk">Time Trial - Racing Towards Practical Remote Timing Attacks</a> paper and looks similar to activesupport&#8217;s implementation.</p>

<figure class='code'><div class="highlight"><table><tr><td class="gutter"><pre class="line-numbers"><span class='line-number'>1</span>
<span class='line-number'>2</span>
<span class='line-number'>3</span>
<span class='line-number'>4</span>
<span class='line-number'>5</span>
<span class='line-number'>6</span>
<span class='line-number'>7</span>
</pre></td><td class='code'><pre><code class=''><span class='line'>
</span><span class='line'>def secure_compare(a, b)
</span><span class='line'>  return false if a.empty? || b.empty? || a.bytesize != b.bytesize l = a.unpack "C#{a.bytesize}"
</span><span class='line'>  res = 0
</span><span class='line'>  b.each_byte { |byte| res |= byte ^ l.shift } 
</span><span class='line'>  res == 0end
</span><span class='line'></span></code></pre></td></tr></table></div></figure>


<h4>Why no secure compare in Ruby?</h4>

<p>You may ask why does Ruby not have a secure compare as part of the core API? I have no idea, but, there has been movement on that front lately and you can follow that discussion in <a href="https://bugs.ruby-lang.org/issues/10098#change-56910">ruby&#8217;s bug discussion area</a>. It&#8217;s currently waiting for Matz approval.</p>

<h3>Research</h3>

<p>I don&#8217;t want to repeat the research that has been conducted by others, so here&#8217;s a review of things I researched and if you&#8217;re interested you should read these to gain more understanding.</p>

<h4>Tools</h4>

<p>Whilst researching I came across the following tools to test for a timing attack. I&#8217;ve not tried them myself but give them a go:</p>

<ul>
<li>https://github.com/dmayer/time_trial</li>
<li>https://github.com/ecbftw/nanown</li>
<li>https://github.com/aj-code/TimingIntrusionTool5000</li>
</ul>


<h4>Papers/Articles</h4>

<ul>
<li><p><a href="https://codeseekah.com/2012/04/29/timing-attacks-in-web-applications/">Timing Attacks in Web Applications</a> -
Gives a very basic introduction to timing attack vulnerability.</p></li>
<li><p><a href="https://codahale.com/a-lesson-in-timing-attacks/">A Lesson In Timing Attacks (or, Donâ€™t use MessageDigest.isEquals)</a> - A very detailed explanation with examples of the actual vulnerability with solutions to fix the issue.</p></li>
<li><p><a href="http://www.security-assessment.com/files/documents/presentations/TimingAttackPresentation2012.pdf">Login timing attacks for mischief and mayhem</a> - This is a presentation into the timing attacks but being a persentation with no audio it&#8217;s a bit hard to know the intention of the speaker, nonetheless, full of useful information.</p></li>
<li><p><a href="https://www.securitee.org/files/timing-attacks_ccs2015.pdf">The Clock is Still Ticking:
Timing Attacks in the Modern Web</a> - Probably one of the best papers I read with practical examples of attacking popular sites like Facebook and LinkedIn to gain a lot more information
regarding site users.</p></li>
<li><p><a href="http://www.cs.rice.edu/~dwallach/pub/crosby-timing2009.pdf">Opportunities and Limits of Remote
Timing Attacks</a> - This paper goes into the details of the actual statistical mesaurements required as part of the a successful timing attack. To be honest, I read the beginning
and realised the Maths was too complicated for my simple brain.</p></li>
<li><p><a href="https://www.blackhat.com/docs/us-15/materials/us-15-Morgan-Web-Timing-Attacks-Made-Practical-wp.pdf">Web Timing Attacks Made Practical</a> - Again, very thought provoking yet a bit heavy on the statistical analysis which is an integral part of a timing attack.</p></li>
<li><p><a href="https://goo.gl/nMFEqk">Time Trial - Racing Towards Practical Remote Timing Attacks</a> - Very detailed and full of great insights. Here&#8217;s a <a href="https://www.youtube.com/watch?v=md6NEmq1n-A">companion presentation</a> on youtube.</p></li>
</ul>


<h4>Books</h4>

<ul>
<li>The Tagled Web A Guide to Securing Modern Web Applications</li>
<li>The Web Application Hackers Handbook</li>
</ul>


<p>This research is not comprehensive and I hope its given you enough to carry on this journey by yourself.</p>

<h3>Update (17.03.2016)</h3>

<p>Good news! Just seen update on <a href="https://bugs.ruby-lang.org/issues/10098#change-57513">the ruby issue</a> and apparently OpenSSL provides a timing safe binary comparison method called
<code>CRYPTO_memcmp</code> which is what will be used in ruby internally and exposed from it to be used by other libraries.</p>
</div>


  <footer>
    <p class="meta">
      
  

<span class="byline author vcard">Posted by <span class="fn">andHapp</span></span>

      





  



<time datetime="2016-02-21T00:00:00+00:00" pubdate  data-updated="true" >Feb 21<span>st</span>, 2016</time>
      


    </p>
    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://ploughthroughruby.co.uk//2016/02/21/timing-attack-ruby-vulnerability.html/" data-via="" data-counturl="http://ploughthroughruby.co.uk//2016/02/21/timing-attack-ruby-vulnerability.html/" >Tweet</a>
  
  
  <div class="g-plusone" data-size="medium"></div>
  
  
    <div class="fb-like" data-send="true" data-width="450" data-show-faces="false"></div>
  
</div>

    
    <p class="meta">
       
        <a class="basic-alignment left" href="/2015/12/06/webpack-dev-server-and-rails.html/" title="Previous Post: Webpack dev server and Rails">&laquo; Webpack dev server and Rails</a>
      
       
        <a class="basic-alignment right" href="/2016/08/29/Improve-bundler-cli.html/" title="next Post: Improve Bundler CLI">Improve Bundler CLI &raquo;</a>
      
    </p>
  </footer>
</article>

</div>

<aside class="sidebar">
  
    <section>
  <h1>My Business</h1>
  <ul id="my_business">
      <li class="post">
        <a href="https://suggestion.io">Suggestion.io</a>
      </li>
      <li class="post">
        <a href="http://www.newstrapper.com">NewsTrapper</a>
      </li>
      <li class="post">
        <a href="http://andhapplimited.co.uk">Consultancy</a>
      </li>
  </ul>
</section>

<section>
  <h1>Recent Posts</h1>
  <ul id="recent_posts">
    
      <li class="post">
        <a href="/2016/10/06/dont-blindly-follow-blog-posts.html/">Don't blindly follow blog posts</a>
      </li>
    
      <li class="post">
        <a href="/2016/09/14/Use-Sequel-for-non-rails-ruby-apps.html/">Use Sequel for non-rails ruby apps</a>
      </li>
    
      <li class="post">
        <a href="/2016/08/29/Improve-bundler-cli.html/">Improve Bundler CLI</a>
      </li>
    
      <li class="post">
        <a href="/2016/02/21/timing-attack-ruby-vulnerability.html/">Timing attack vulnerability in Rails</a>
      </li>
    
      <li class="post">
        <a href="/2015/12/06/webpack-dev-server-and-rails.html/">Webpack dev server and Rails</a>
      </li>
    
  </ul>
</section>

<!-- Begin MailChimp Signup Form -->
<div id="mc_embed_signup">
<form action="http://andhapp.us3.list-manage.com/subscribe/post?u=8f39182205ca41412cd1301ed&amp;id=4d157fe12d" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
	<label for="mce-EMAIL">For interesting articles, subscribe to our mailing list</label>
	<input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
    <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
    <div style="position: absolute; left: -5000px;"><input type="text" name="b_8f39182205ca41412cd1301ed_4d157fe12d" value=""></div>
	<div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
</form>
</div>
<!--End mc_embed_signup-->




  
</aside>


    </div>
  </div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2016 - andHapp -
  <span class="credit">Powered by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>
  


<div id="fb-root"></div>
<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) {return;}
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#appId=212934732101925&xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>


  <script type="text/javascript">
    (function() {
      var script = document.createElement('script'); script.type = 'text/javascript'; script.async = true;
      script.src = 'https://apis.google.com/js/plusone.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(script, s);
    })();
  </script>



  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>



  <script type="text/javascript">
    var _gaq = _gaq || [];
    _gaq.push(['_setAccount', 'UA-7379349-5']);
    _gaq.push(['_trackPageview']);

    (function() {
      var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
      ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
      var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
    })();
  </script>





</body>
</html>
